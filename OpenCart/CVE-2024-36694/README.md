# OpenCart v4.0.2.3 - Server-Side Template Injection
Hi everyone, I discovered a Server-Side Template Injection vulnerability that can lead to Remote Code Execution (RCE) with admin privileges in OpenCart v4.0.2.3. I’ve written this article to explain the steps we took to identify and exploit this vulnerability.

<p align="center">
  <img src="https://github.com/user-attachments/assets/21777984-48ce-482e-a08e-78d0387bc1ee">
</p>

# What is OpenCart?
OpenCart is a free open source e-commerce platform for online merchants. OpenCart provides a professional and reliable foundation from which to build a successful online store.

# What is Server-Side Template Injection (SSTI)?
Server-Side Template Injection (SSTI) occurs when user input is improperly included in a template without proper validation or sanitization, allowing an attacker to inject malicious code into the server-side template. If the template engine executes this injected code, it can lead to serious security issues, including Remote Code Execution (RCE).

# Proof of Concept (POC)
The following is step to reproduce:

<p align="center">
  <img src="https://github.com/user-attachments/assets/d740df80-dfb5-42f9-b171-217bb95e3316">
</p>

First, we log in as admin.

<p align="center">
  <img src="https://github.com/user-attachments/assets/d255fa70-49ac-4c2e-a9b1-8c32eca4972b">
</p>

Next, we navigate to Design -> Theme Editor -> error.

<p align="center">
  <img src="https://github.com/user-attachments/assets/749131a4-1554-4d0b-b54d-e4b3bd9cee65">
</p>

Next, we click on not_found.twig template.

<p align="center">
  <img src="https://github.com/user-attachments/assets/16596f1c-73ab-4ebb-b7d5-9fd3ebfce494">
</p>

Next, we insert {{ 7*7 }} into the content of not_found.twig and click the save button to check if the expression is executed. If it is executed, the result is rendered as 49.

<p align="center">
  <img src="https://github.com/user-attachments/assets/c50314d9-fd6c-4f2e-b0d4-84f29b429936">
</p>

Next, we go to the shop page at “index.php” and then we click on some product.

<p align="center">
  <img src="https://github.com/user-attachments/assets/cbf0349e-acf9-414b-9259-7289593f6552">
</p>

Next, we found in the URL have a route parameter.

<p align="center">
  <img src="https://github.com/user-attachments/assets/27af4030-29b7-4d0b-a524-222301744bc8">
</p>

Next, we modify the route parameter value to ‘notfoundpage’ and press Enter to trigger the not_found.twig template, where we inserted {{ 7*7 }}.
we found the {{ 7*7 }} we inserted is executed to render as 49 at the bottom of the page.

<p align="center">
  <img src="https://github.com/user-attachments/assets/f7dad7dd-c473-4b15-a8de-b85a46730336">
</p>

Next, we append {{[‘id’]|map(‘system’)|join}} to the content of the not_found.twig template in an attempt to execute an OS command.

<p align="center">
  <img src="https://github.com/user-attachments/assets/c25a2177-d30c-40b4-9f01-27002cc8d2ca">
</p>

Finally, we return to the shop page using the route we modified, and we observe that the OS command has been executed.

<p align="center">
  <img src="https://github.com/user-attachments/assets/6ee3d665-8069-42b5-adde-f875e9993683">
</p>

# Recommendation
1. Disable Dangerous Twig Functions <br>
Disable or restrict access to functions that could allow an attacker to execute code on the server, such as eval(), include(), sys(), or others. You can do this by configuring the Twig_Environment to disable these functions:

```php
$twig = new \Twig\Environment($loader, [
    'autoescape' => 'html',
    'sandbox' => true, // Enable sandbox mode
]);
```
2. Use the sandbox Extension
If you need to allow user-generated templates, use Twig’s Sandbox Extension, which creates a restricted environment for templates and prevents dangerous operations:

```php
$sandbox = new \Twig\Extension\SandboxExtension($twig, $policy);
$twig->addExtension($sandbox);
```

# Reference
- https://github.com/opencart/opencart/issues/13863
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=2024-36694

> CVE-2024-36694
